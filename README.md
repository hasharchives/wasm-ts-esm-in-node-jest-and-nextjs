# WASM + TypeScript + ESM in Node.js, Jest and Next.js

This demo contains a web app that depends on a [WASM](https://webassembly.org/) package with TypeScript and native ESModules.
WASM is used in a Node.js script, a Jest test and a Next.js app with a page and an API route.

## Prerequisites

- [Node.js](https://nodejs.org/en/) v16 or higher
- [Yarn](https://yarnpkg.com/)
- [Rust](https://www.rust-lang.org/tools/install) and [`wasm-pack`](https://rustwasm.github.io/wasm-pack/installer/) (unless you want to skip steps 2 and 3 of the demo)

## Demo steps

1.  Clone the repo and install dependencies from the root folder:

    ```sh
    yarn install
    ```

1.  _(can be skipped)_ Generate `wasm-package` from `wasm-crate`:

    ```sh
    cd wasm-crate
    wasm-pack build --out-dir ../wasm-package --target=bundler
    cd ..
    ```

1.  _(can be skipped)_ Tweak `wasm-package`:

    ```sh
    ## Enable native ESM in package.json
    yarn replace-in-file "/\"module\":/" "\"type\": \"module\", \"main\":" wasm-package/package.json --isRegex
    yarn prettier --write wasm-package/package.json

    ## Remove autogenerated .gitignore
    rm wasm-package/.gitignore
    ```

1.  ðŸŽ‰ Run a Node.js script that uses the `wasm-package`:

    ```sh
    yarn workspace web-app exe scripts/wasm-package-demo.ts
    ```

1.  ðŸŽ‰ Run unit tests ([patched](./.yarn/patches) Jest) referring to the `wasm-package`:

    ```sh
    yarn workspace web-app test
    ```

1.  ðŸŽ‰ Run Next.js dev server and check if `wasm-package` works there too:

    ```sh
    yarn workspace web-app dev
    ```

    Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

    ***

1.  ðŸš¨ Build and run the production version Next.js app:

    ```sh
    yarn workspace web-app build
    yarn workspace web-app start
    ```

    > ðŸš¨ `build` is broken as of Next 12.3.1 or Next 12.3.2-canary.27.
    > Seems like Next.js does not like wasm imports in SSR page code.
    > Using wasm in a client-only [dynamic import](https://nextjs.org/docs/advanced-features/dynamic-import) works.
    > Bug report pending.
